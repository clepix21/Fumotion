name: Fumotion CI/CD

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

env:
  NODE_VERSION: "18"

jobs:
  tests-backend:
    runs-on: ubuntu-latest
    name: Tests API Backend

    services:
      # Ajout d'un service de base de données temporaire pour les tests
      sqlite-memory:
        image: cimg/node:18.0
        ports:
          - 3306:3306

    steps:
      - name: Récupération du code source
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'app/backend/package-lock.json'

      - name: Installation dépendances backend
        run: |
          cd app/backend
          npm ci

      - name: Création fichier environnement de test
        run: |
          cd app/backend
          echo "PORT=5000" > .env
          echo "JWT_SECRET=cle_secrete_test_pour_ci" >> .env
          echo "DB_PATH=./database/test.db" >> .env
          echo "NODE_ENV=test" >> .env

      - name: Création répertoire base de données
        run: |
          mkdir -p app/backend/database

      # Ajout de tests unitaires avant de démarrer le serveur
      - name: Tests unitaires backend
        run: |
          cd app/backend
          npm test || exit 1

      - name: Démarrage serveur backend pour tests
        run: |
          cd app/backend
          npm start &
          echo "::group::Attente démarrage serveur"
          for i in {1..30}; do
            if curl -s http://localhost:5000/api/health > /dev/null; then
              echo "Serveur démarré avec succès après $i secondes"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Timeout: Le serveur n'a pas démarré dans le temps imparti"
              exit 1
            fi
            sleep 1
          done
          echo "::endgroup::"

      - name: Tests API backend
        run: |
          cd app/backend
          echo "::group::Test endpoint santé API"
          curl -f http://localhost:5000/api/health || exit 1
          echo "::endgroup::"
          
          echo "::group::Test endpoint inscription API"
          curl -X POST http://localhost:5000/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"firstName":"Test","lastName":"Utilisateur","email":"test@ci.com","password":"motdepasse123"}' \
            || exit 1
          echo "::endgroup::"
          
          echo "::group::Test endpoint recherche trajets API"
          curl -f http://localhost:5000/api/trips/search || exit 1
          echo "::endgroup::"

  tests-frontend:
    runs-on: ubuntu-latest
    name: Tests et Build Frontend

    steps:
      - name: Récupération du code source
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'app/frontend/package-lock.json'

      - name: Installation dépendances frontend
        run: |
          cd app/frontend
          npm ci

      # Configuration pour résoudre le problème d'import CSS dans Jest
      - name: Configuration du mock pour CSS dans Jest
        run: |
          cd app/frontend
          echo '{
            "jest": {
              "moduleNameMapper": {
                "\\.(css|less|scss|sass)$": "identity-obj-proxy"
              }
            }
          }' > jest.config.json
          npm install --save-dev identity-obj-proxy

      - name: Création fichier environnement frontend
        run: |
          cd app/frontend
          echo "REACT_APP_API_URL=http://localhost:5000" > .env

      - name: Vérification qualité code frontend
        run: |
          cd app/frontend
          npm run lint || echo "Vérification lint terminée avec avertissements"

      - name: Exécution tests frontend
        run: |
          cd app/frontend
          CI=true npm test -- --watchAll=false --config=jest.config.json

      - name: Build production frontend
        run: |
          cd app/frontend
          npm run build

      - name: Vérification sortie build
        run: |
          cd app/frontend
          ls -la build/
          test -f build/index.html || exit 1
          
      # Stockage des artéfacts de build pour inspection ou déploiement ultérieur
      - name: Stockage artéfacts build
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: app/frontend/build/
          retention-days: 7

  security-scan:
    runs-on: ubuntu-latest
    name: Analyse de Sécurité
    needs: []  # Exécution parallèle avec les autres jobs

    steps:
      - name: Récupération du code source
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Scan des vulnérabilités dans les dépendances
      - name: Audit de sécurité Backend
        run: |
          cd app/backend
          npm audit --production --audit-level=high || echo "Des vulnérabilités ont été détectées"
          
      - name: Audit de sécurité Frontend
        run: |
          cd app/frontend
          npm audit --production --audit-level=high || echo "Des vulnérabilités ont été détectées"

      # Scan de code statique avec CodeQL
      - name: Initialisation CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: Analyse CodeQL
        uses: github/codeql-action/analyze@v2

  tests-integration:
    runs-on: ubuntu-latest
    name: Tests d'Intégration
    needs: [tests-backend, tests-frontend]

    steps:
      - name: Récupération du code source
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installation toutes dépendances
        run: |
          # Installation dépendances racine
          npm ci
          # Installation dépendances backend
          cd app/backend && npm ci && cd ../..
          # Installation dépendances frontend
          cd app/frontend && npm ci && cd ../..

      - name: Configuration environnement test
        run: |
          # Environnement backend
          cd app/backend
          echo "PORT=5000" > .env
          echo "JWT_SECRET=secret_integration_test" >> .env
          echo "DB_PATH=./database/integration.db" >> .env
          echo "NODE_ENV=test" >> .env
          mkdir -p database
          cd ../..
          
          # Environnement frontend
          cd app/frontend
          echo "REACT_APP_API_URL=http://localhost:5000" > .env
          cd ../..

      - name: Démarrage serveur backend
        run: |
          cd app/backend
          npm start &
          # Attente plus intelligente du démarrage du serveur
          for i in {1..30}; do
            if curl -s http://localhost:5000/api/health > /dev/null; then
              echo "Serveur démarré avec succès après $i secondes"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Timeout: Le serveur n'a pas démarré dans le temps imparti"
              exit 1
            fi
            sleep 1
          done

      - name: Build et test frontend avec backend
        run: |
          cd app/frontend
          npm run build
          
      - name: Exécution tests API intégration
        run: |
          # Test flux inscription utilisateur
          echo "::group::Test inscription"
          curl -X POST http://localhost:5000/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"firstName":"Integration","lastName":"Test","email":"integration@test.com","password":"motdepasseintegration123"}' \
            -s | tee response.json
          grep -q "success" response.json || exit 1
          echo "::endgroup::"
          
          # Test endpoint trajets
          echo "::group::Test trajets"
          curl -s http://localhost:5000/api/trips/search | tee trips.json
          grep -q "success\|trips" trips.json || exit 1
          echo "::endgroup::"

  qualite-code:
    runs-on: ubuntu-latest
    name: Contrôle Qualité Code
    needs: []  # Exécution parallèle

    steps:
      - name: Récupération du code source
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Installation dépendances
        run: |
          cd app/backend && npm ci && cd ../..
          cd app/frontend && npm ci && cd ../..

      # Analyse de la complexité du code
      - name: Installation outils d'analyse
        run: |
          npm install -g eslint jscpd

      - name: Vérification formatage et duplication code backend
        run: |
          cd app/backend
          echo "::group::Structure code backend"
          find . -name "*.js" -not -path "./node_modules/*" | wc -l
          echo "::endgroup::"
          
          echo "::group::Analyse duplication code backend"
          jscpd . --ignore "node_modules/**" --threshold 5 || echo "Attention: Code dupliqué détecté"
          echo "::endgroup::"

      - name: Vérification formatage et duplication code frontend
        run: |
          cd app/frontend
          echo "::group::Structure code frontend"
          find src -name "*.js" -o -name "*.jsx" | wc -l
          echo "::endgroup::"
          
          echo "::group::Analyse duplication code frontend"
          jscpd src --threshold 5 || echo "Attention: Code dupliqué détecté"
          echo "::endgroup::"

      - name: Validation fichiers package.json
        run: |
          # Validation package.json backend
          cd app/backend && npm ls --depth=0
          cd ../frontend && npm ls --depth=0

  # Workflow de déploiement conditionnel pour la branche main
  deploy:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    name: Déploiement
    needs: [tests-integration, security-scan]
    
    steps:
      - name: Récupération artéfacts build
        uses: actions/download-artifact@v3
        with:
          name: frontend-build
          path: frontend-build

      - name: Vérification des artéfacts
        run: |
          ls -la frontend-build/
          echo "Le déploiement serait exécuté ici dans un environnement de production réel"