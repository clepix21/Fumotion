name: Fumotion CI/CD

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

env:
  NODE_VERSION: "18"

jobs:
  tests-backend:
    runs-on: ubuntu-latest
    name: Tests API Backend

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password_test
          MYSQL_DATABASE: fumotion_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Récupération du code source
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'app/backend/package-lock.json'

      - name: Installation dépendances backend
        run: |
          cd app/backend
          npm ci

      - name: Création fichier environnement de test
        run: |
          cd app/backend
          echo "PORT=5000" > .env
          echo "JWT_SECRET=cle_secrete_test_pour_ci" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_USER=root" >> .env
          echo "DB_PASSWORD=root_password_test" >> .env
          echo "DB_NAME=fumotion_test" >> .env
          echo "NODE_ENV=test" >> .env

      - name: Démarrage serveur backend pour tests
        run: |
          cd app/backend
          npm start &
          BACKEND_PID=$!
          echo "Backend démarré avec PID: $BACKEND_PID"
          
          # Attendre que le serveur soit prêt (max 60 secondes)
          echo "Attente du démarrage du serveur..."
          for i in {1..60}; do
            if curl -f http://localhost:5000/api/health 2>/dev/null; then
              echo "Serveur backend prêt après ${i} secondes"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Timeout: le serveur n'a pas démarré en 60 secondes"
              exit 1
            fi
            sleep 1
          done

      - name: Test endpoint santé API
        run: |
          curl -f http://localhost:5000/api/health || exit 1

      - name: Test endpoint inscription API
        run: |
          response=$(curl -X POST http://localhost:5000/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"firstName":"Test","lastName":"Utilisateur","email":"test@ci.com","password":"motdepasse123"}' \
            -s)
          echo "Réponse inscription: $response"
          echo "$response" | grep -q "success" || exit 1

      - name: Test endpoint recherche trajets API
        run: |
          curl -f http://localhost:5000/api/trips/search || exit 1

  tests-frontend:
    runs-on: ubuntu-latest
    name: Tests et Build Frontend

    steps:
      - name: Récupération du code source
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'app/frontend/package-lock.json'

      - name: Installation dépendances frontend
        run: |
          cd app/frontend
          npm ci

      - name: Création fichier environnement frontend
        run: |
          cd app/frontend
          echo "REACT_APP_API_URL=http://localhost:5000" > .env

      - name: Exécution tests frontend
        run: |
          cd app/frontend
          CI=true npm test -- --watchAll=false

      - name: Build production frontend
        run: |
          cd app/frontend
          npm run build

      - name: Vérification sortie build
        run: |
          cd app/frontend
          ls -la build/
          test -f build/index.html || exit 1

  tests-integration:
    runs-on: ubuntu-latest
    name: Tests d'Intégration
    needs: [tests-backend, tests-frontend]

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password_integration
          MYSQL_DATABASE: fumotion_integration
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Récupération du code source
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Installation toutes dépendances
        run: |
          # Installation dépendances backend
          cd app/backend && npm ci && cd ../..
          # Installation dépendances frontend
          cd app/frontend && npm ci && cd ../..

      - name: Configuration environnement test
        run: |
          # Environnement backend
          cd app/backend
          echo "PORT=5000" > .env
          echo "JWT_SECRET=secret_integration_test" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_USER=root" >> .env
          echo "DB_PASSWORD=root_password_integration" >> .env
          echo "DB_NAME=fumotion_integration" >> .env
          echo "NODE_ENV=test" >> .env
          cd ../..
          
          # Environnement frontend
          cd app/frontend
          echo "REACT_APP_API_URL=http://localhost:5000" > .env
          cd ../..

      - name: Démarrage serveur backend
        run: |
          cd app/backend
          npm start > backend.log 2>&1 &
          BACKEND_PID=$!
          echo "Backend démarré avec PID: $BACKEND_PID"
          
          # Attendre que le serveur soit prêt
          echo "Attente du démarrage du serveur backend..."
          for i in {1..60}; do
            if curl -f http://localhost:5000/api/health 2>/dev/null; then
              echo "✅ Backend prêt après ${i} secondes"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "❌ Timeout: le backend n'a pas démarré"
              echo "=== Logs Backend ==="
              cat backend.log
              exit 1
            fi
            sleep 1
          done

      - name: Build et test frontend avec backend
        run: |
          cd app/frontend
          npm run build
          
      - name: Exécution tests API intégration
        run: |
          # Test flux inscription utilisateur
          curl -X POST http://localhost:5000/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"firstName":"Integration","lastName":"Test","email":"integration@test.com","password":"motdepasseintegration123"}' \
            -s | grep -q "success"
          
          # Test endpoint trajets
          curl -s http://localhost:5000/api/trips/search | grep -q "success\|trips"

  qualite-code:
    runs-on: ubuntu-latest
    name: Contrôle Qualité Code

    steps:
      - name: Récupération du code source
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Installation dépendances
        run: |
          cd app/backend && npm ci && cd ../..
          cd app/frontend && npm ci && cd ../..

      - name: Vérification formatage code backend
        run: |
          cd app/backend
          echo "Vérification structure code backend..."
          find . -name "*.js" -not -path "./node_modules/*" | wc -l

      - name: Vérification formatage code frontend
        run: |
          cd app/frontend
          echo "Vérification structure code frontend..."
          find src -name "*.js" -o -name "*.jsx" | wc -l

      - name: Validation fichiers package.json
        run: |
          # Validation package.json backend
          cd app/backend && npm ls --depth=0
          cd ../frontend && npm ls --depth=0